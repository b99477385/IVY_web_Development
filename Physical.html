<!DOCTYPE html>
<html>
    <head>
        <style>
        body{
            margin: 0;
        }
        #chaptertablesection{
            width: 100%;
            font-family: Georgia, 'Times New Roman', Times, serif;
        }
        #chaptercontentsection{
            /* height is tempory setting to test the scroll funciton */
            font-family: Georgia, 'Times New Roman', Times, serif;
            width: 100%;
            height: 1000px; 
            display: none;

        }
        
        #subjecthead{
            text-align: center;
            width: 313px;
            height: 62px;
            font-size: 64px;
            font-weight:900;
            margin-left: 8%;
            margin-bottom: 80px;
        }

        a{
            text-decoration: none;
            color: black;        
        }

        a:hover{
            color: rgb(74, 227, 74);
        }

        .chapterable{
            text-align: center;
            width: 90%;
            margin-left: 5%;
            margin-right: 5%;

        }
        .years{
            font-size: 48px;
            width: 33%;
            height: 62px;
            font-weight: 600;
            padding-bottom: 50px;
        }

        .chaptertablecell{
            text-align: center;
            font-size: 40px;
            font-weight: 400;
            width: 33%;
            
        }

        #conceptlisthead{
  
            font-size: 48px;
            margin-left: 7% ;
            font-weight: 600;
            margin-bottom: 20px;
            
        }
        .conceptlist{
            margin: 0%;
            font-size: 32px;
            font-weight: 400;

            
        }

        #concepttablesection{
            width: 100%;
            background-color:#96d7ca;
            padding-left: 5%;
    
            
        }
        #conceptvideosection{
            text-align: center;
        }
        
        
        </style>
        <script type = "text/javascript">

        /* use gviz to request the data from google spreadsheet  */

        const url_base = 'https://docs.google.com/spreadsheets/d/1EsiS7h3QJNDn0hIvGr6pKy-7yS5EIkmlf-OfZhaqCFg/gviz/tq?tqx=out:csv&tq=SELECT '
        const subject = '物理'

        function tablecreate(){

        /* fetch data */    
            
            let freshman,sophomore,junior
            let selection = 'E , count(B) where D contains \"' + subject + '\" AND C contains' + '"一" group by E'
            let url = url_base + selection
            freshman = fetch(url).then((response) => response.text()).then((data) => {return data_handle(data)})
            selection = 'E , count(B) where D contains \"' + subject + '\" AND C contains' + '"二" group by E'
            url = url_base + selection
            sophomore =  fetch(url).then((response) => response.text()).then((data) => {return data_handle(data)})
            selection = 'E , count(B) where D contains \"' + subject + '\" AND C contains' + '"三" group by E'
            url = url_base + selection
            junior =  fetch(url).then((response) => response.text()).then((data) => {return data_handle(data)})
    
        /* bundle three different get requests' promise to build Chapter table */

            Promise.all([freshman,sophomore,junior]).then((chapterset) => {
                let table = [];
                table.push("<tr><th class =\"years\">高一</th><th class =\"years\">高二</th><th class =\"years\">高三</th></tr>")
                let index = 0;
                let l1 = chapterset[0].length, l2 = chapterset[1].length, l3 = chapterset[2].length;
                let prefix = "<td class=\"chaptertablecell\"><a href =\"javascript:void(0)\" onclick=\"javascript:conceptlist('"
                let middle = "');scroll_window('conceptlisthead');return false;\">"
                let suffix = "</a></td>"
                let dummy = "<td class=\"chaptertablecell\"></td>"
                while (index < l1 || index < l2 || index < l3) {
                    table.push("<tr>")
                    if (index < l1) {
                        table.push(prefix + chapterset[0][index] + middle + chapterset[0][index] + suffix + "")
                    } else {
                        table.push(dummy);
                    } 
                    if (index < l2) {
                        table.push(prefix + chapterset[1][index] + middle + chapterset[1][index] + suffix + "")
                    } else {
                        table.push(dummy);
                    }
                    if (index < l3) {
                        table.push(prefix + chapterset[2][index] + middle + chapterset[2][index] + suffix + "")
                    } else {
                        table.push(dummy);
                    }
                    table.push("</tr>")
                    index+=1;
                }
                table = "<p id=\"subjecthead\">"+subject+"</p><table class=\"chapterable\">" +table.join("") +"</table>"
                document.getElementById("chaptertablesection").innerHTML = table
            });
            
        }

        function data_handle(rawdata){
            let rows = rawdata.split(/\r?\n|\r/)
            let chapters = []
            for (i = 1; i < rows.length; i++) {
                var items = rows[i].split(",")
                chapters.push(items[0].slice(1,-1))
            }
            return chapters
        }

    
        /* concepttable for the chapter */
    
        function conceptlist(chaptername){
            let selection = 'F where E contains"' + chaptername + '"'
            let url  = url_base + selection
            fetch(url).then((response) => response.text()).then((data) => {
                let rows = [];
                let list = [];
                let firstconcept_chapter;
                rows = data.split(/\r?\n|\r/)
                firstconcept_chapter = rows[0].slice(1,-1)
                for (var i = 0; i < rows.length;i++) {
                    let concept = rows[i].slice(1,-1)
                    list.push("<p class = \"conceptlist\"><a href =\"javascript:void(0)\" onclick=\"javascript:changeconcept('" + concept + "');scroll_window('videohead');return false;\">"+ concept + "</a></p>")
                }
                document.getElementById("conceptlisthead").innerText = "章節名稱：" + chaptername
                changeconcept(firstconcept_chapter)
                document.getElementById("chaptercontentsection").style.display = "block";
                document.getElementById("concepttablesection").innerHTML = list.join("")
                scroll_window('conceptlisthead') //to fix the first click on chaptername when the chaptercontentsection's display is none will fail to scroll the window
            })
        }

        /* change the youtube URL to its video id# */

        function getId(origin_yt_url){
            let regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            let match = origin_yt_url.match(regExp);
            return (match && match[2].length === 11)
            ? match[2]
            : null;
        }

        /* function to change the video according to selected concept */

        function changeconcept(conceptname){
            let selection = 'H where F contains"' + conceptname + '"'
            let url = url_base + selection
            fetch(url).then((response) => response.text()).then((data) => {        
                let concept_video_url = []
                concept_video_url = data.split(/\r?\n|\r/)
                enbeded_id = getId(concept_video_url[0])
                document.getElementById("video").src = "https://www.youtube.com/embed/" + enbeded_id + ""
                document.getElementById("videohead").innerText = conceptname;
            })
        }
        function scroll_window(item_id){
            let element = document.getElementById(item_id+"")
            element.scrollIntoView({block: "start", inline: "nearest", behavior: "smooth"})
        }

        tablecreate()

        </script> 
    </head>
    <body>
        <div id = "chaptertablesection"></div>
        <div id = "chaptercontentsection">
            <p id = "conceptlisthead">章節名稱:</p>
            <div id = "concepttablesection"></div>
            <div id = "conceptvideosection">
                <h2 id = "videohead" ></h2>
                <iframe id = "video"  width = "560" height = "315" src = ""></iframe>        
            </div>
        </div>
    </body>
</html>



