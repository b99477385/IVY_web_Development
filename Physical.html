<!DOCTYPE html>
<html>
    <head>
        <style>
        body{
            margin: 0;
            font-family: 'Zen Antique';
            /* min-width: 600px; */
        }
        #chaptertablesection{
            width: 100%;
            font-family: 'Zen Antique';
            min-height: 70vw;            
        }

        #chaptercontentsection{
            /* height is tempory setting to test the scroll funciton */
            font-family: 'Zen Antique';
            width: 100%;
            height: auto;
            display: none;
        }
        
        #subjecthead{
            font-size: 4.44vw; /* 64 / 1440 * 100 */
            font-weight: 900;
            width: 21.74vw;
            margin-top: 15.2vw;
            margin-left: 6.59vw;
            text-align: center;
            margin-bottom: 5vw;
            display: block;             
        }

        a{
            text-decoration: none;
            color: black;        
        }

        a:hover{
            color: #00A490;
        }

        .chapterable{
            text-align: center;
            width: 94vw;
            margin-left: 3vw;
            margin-right: 3vw;
            margin-bottom: 6.25vw;
        }
        .years{
            font-size: 3.33vw;
            width: 33.3%;
            padding-top: 1vw;
            padding-bottom: 1vw;
            font-weight: 600;

        }

        .chaptertablecell{
            text-align: center;
            font-size: 2.78vw;
            font-weight: 400;
            width: 33.3%;
            padding-top: 1vw;
            padding-bottom: 1vw;
            
        }

        #contenthead{
            display: flex;
            justify-content: space-between;
            flex-direction: row;
        }

        #conceptlisthead{
            display: flex;
            font-size: 3.33vw;
            font-weight: 600;
            text-align: center;
            align-items: center;
            width: 33.06vw;
            height: 7.09vw;
            margin-left: 8.62vw;
            margin-top: 0;
            margin-bottom: 0%;            
        }

        #returntopbuttom{
            display: flex;
            align-items: flex-end;
            text-align: right;
            margin: 0%;
            padding: 0%;
            font-size: 1.67vw;
            color: #6f6f6f;
            padding-right: 1.59vw;
        }

        .conceptlist{
            margin: 0%;
            font-weight: 400;
            font-size: 2.22vw;
            padding-top: 1vw;
            padding-bottom: 1vw;
            margin-left: 8.61vw;
            text-align: left;
            display: block;
        }

        #videohead{
            font-size: 3.33vw;
        }

        #conceptlistsection{
            width: 100%;
            background-color: rgb(0, 164, 144, 0.13);

        }

        #animationheadersection{
            width: 100%;
            background-color: rgb(0, 173, 152, 0.4);
        }

        #praitceheardersection{
            width: 100%;
            background-color: rgb(0, 137, 121, 0.4);
        }

        #listsection{
            margin-bottom: 7.64vw;
        }
        #conceptvideosection{
            display: flexbox;
            justify-content: center;

            text-align: center;
        }
        .conceptvideo{
            width: 60vw;
            height: 30vw;
        }
        #animationsection{
            display: flex;
            width: 80vw;
            flex-direction: column;
            justify-content: center;
            text-align: center;

        }
        #animationsection_head{
            font-size: 3.33vw;
        }
        
        </style>
        <script type = "text/javascript">

        /* use gviz to request the data from google spreadsheet  */

        const url_base = 'https://docs.google.com/spreadsheets/d/1EsiS7h3QJNDn0hIvGr6pKy-7yS5EIkmlf-OfZhaqCFg/gviz/tq?tqx=out:csv&tq=SELECT '
        const subject = '物理'

        function tablecreate(){

        /* fetch data */    
            
            let freshman,sophomore,junior
            let selection = 'E , count(B) where D contains \"' + subject + '\" AND C contains' + '"一" group by E'
            let url = url_base + selection
            freshman = fetch(url).then((response) => response.text()).then((data) => {return data_handle(data)})
            selection = 'E , count(B) where D contains \"' + subject + '\" AND C contains' + '"二" group by E'
            url = url_base + selection
            sophomore =  fetch(url).then((response) => response.text()).then((data) => {return data_handle(data)})
            selection = 'E , count(B) where D contains \"' + subject + '\" AND C contains' + '"三" group by E'
            url = url_base + selection
            junior =  fetch(url).then((response) => response.text()).then((data) => {return data_handle(data)})
    
        /* bundle three different get requests' promises to build Chapter table */

            Promise.all([freshman,sophomore,junior]).then((chapterset) => {
                let table = [];
                table.push("<tr><th class =\"years\">高一</th><th class =\"years\">高二</th><th class =\"years\">高三</th></tr>")
                let index = 0;
                let l1 = chapterset[0].length, l2 = chapterset[1].length, l3 = chapterset[2].length;
                let prefix = "<td class=\"chaptertablecell\"><a href =\"javascript:void(0)\" onclick=\"javascript:conceptlist('"
                let middle = "');scroll_window('conceptlisthead');return false;\">"
                let suffix = "</a></td>"
                let dummy = "<td class=\"chaptertablecell\"></td>"
                while (index < l1 || index < l2 || index < l3) {
                    table.push("<tr>")
                    if (index < l1) {
                        table.push(prefix + chapterset[0][index] + middle + chapterset[0][index] + suffix + "")
                    } else {
                        table.push(dummy);
                    } 
                    if (index < l2) {
                        table.push(prefix + chapterset[1][index] + middle + chapterset[1][index] + suffix + "")
                    } else {
                        table.push(dummy);
                    }
                    if (index < l3) {
                        table.push(prefix + chapterset[2][index] + middle + chapterset[2][index] + suffix + "")
                    } else {
                        table.push(dummy);
                    }
                    table.push("</tr>")
                    index+=1;
                }
                table = "<p id=\"subjecthead\">"+subject+"</p><table class=\"chapterable\">" +table.join("") +"</table>"
                document.getElementById("chaptertablesection").innerHTML = table
            });
            
        }

        function data_handle(rawdata){
            let rows = rawdata.split(/\r?\n|\r/)
            let chapters = []
            for (i = 1; i < rows.length; i++) {
                let items = rows[i].split(",")
                chapters.push(items[0].slice(1,-1))
            }
            return chapters
        }

    
        /* concepttable for the chapter */
    
        function conceptlist(chaptername){
            let selection = 'F where E contains"' + chaptername + '"'
            let url  = url_base + selection
            fetch(url).then((response) => response.text()).then((data) => {
                let rows = [];
                let list = [];
                let firstconcept_chapter;
                rows = data.split(/\r?\n|\r/)
                firstconcept_chapter = rows[0].slice(1,-1)
                for (var i = 0; i < rows.length;i++) {
                    let concept = rows[i].slice(1,-1)
                    list.push("<a class = \"conceptlist\" href =\"javascript:void(0)\" onclick=\"javascript:changeconcept('" + concept + "');scroll_window('videohead');return false;\">"+ concept + "</a>")
                }
                document.getElementById("conceptlisthead").innerText = "章節名稱：" + chaptername
                changeconcept(firstconcept_chapter)
                document.getElementById("chaptercontentsection").style.display = "block";
                document.getElementById("conceptlistsection").innerHTML = list.join("")
                scroll_window('conceptlisthead') //to fix the first click on chaptername when the chaptercontentsection's display is none will fail to scroll the window
            })
        }

        /* change the youtube URL to its video id# */

        function getId(origin_yt_url){
            let regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            let match = origin_yt_url.match(regExp);
            return (match && match[2].length === 11)
            ? match[2]
            : null;
        }

        /* function to change the video according to selected concept */

        function changeconcept(conceptname){
            concept_video_load(conceptname)
            animation_load(conceptname)
        }

        function concept_video_load(conceptname){
            let selection = 'I where F contains"' + conceptname + '"'
            let url = url_base + selection
            fetch(url).then((response) => response.text()).then((data) => {        
                let concept_video_url = []
                let embedvideosrc = []
                let conceptvideos = "<p id = \"videohead\" >章節名稱 : " + conceptname + "</p>"
                concept_video_url = data.split(/\r?\n|\r/)
                for( let i = 0 ; i < concept_video_url.length ; i++ ) {
                    embeded_id = getId(concept_video_url[i])
                    embedvideosrc = "https://www.youtube.com/embed/" + embeded_id + ""
                    conceptvideos += " <iframe class = \"conceptvideo\"  src = \"" + embedvideosrc + "\"></iframe> "
                }
                document.getElementById("conceptvideosection").innerHTML = conceptvideos+""                
            })
        }

        function animation_load(conceptname){
            let selection = 'G, H where F contains"' + conceptname + '"'
            let url = url_base + selection
            fetch(url).then((response) => response.text()).then((data) => {        
                let animation_url_explaination = []
                let animation_url
                let anmation_explaination
                let animation_innerhtml = "<p id = \"animationsection_head\">動畫操作</p>"
                animation_url_explaination = data.split(/\r?\n|\r/)
                for( let i = 0 ; i < animation_url_explaination.length ; i++ ) {
                    let url_explaination = animation_url_explaination[i].split(",")
                    animation_url = url_explaination[0].slice(1,-1)
                    animation_explaination = url_explaination[1].slice(1,-1)
                    console.log(animation_url)
                    console.log(animation_explaination)
                    animation_innerhtml += "<p class = \"ani_explain\">" + animation_explaination + "</p>"
                    animation_innerhtml += "<a class = \"ani_link\" href = " + animation_url + ">" + animation_url + "</a>"
                }
                document.getElementById("animationsection").innerHTML = animation_innerhtml + ""                
            })
        }

        function scroll_window(item_id){
            let element = document.getElementById(item_id+"")
            element.scrollIntoView({block: "start", inline: "nearest", behavior: "smooth"})
        }


        tablecreate()

        </script> 
    </head>
    <body>
        <div id = "chaptertablesection"></div>
        <div id = "chaptercontentsection">
            <div id = "contenthead">
                <p id = "conceptlisthead">章節名稱:</p>
                <a id = "returntopbuttom" href = "javascript:void(0)" onclick = "javascript : scroll_window('chaptertablesection') ; return false ;" >∧ return to top</a>
            </div>
            <div id = "listsection">
                <div id = "conceptlistsection"></div>
                <div id = "animationheadersection">
                    <a class = "conceptlist" href = "javascript:void(0)" onclick = "javascript : scroll_window('animationsection') ; return false ;" >動畫操作</a>
                </div>
                <div id = "praitceheardersection">
                    <a class = "conceptlist" >練習題</a>
                </div>
            </div>
            <div id = "conceptvideosection"></div>
            <div id = "animationsection"></div>
        </div>
    </body>
</html>
